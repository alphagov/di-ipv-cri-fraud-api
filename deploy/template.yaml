AWSTemplateFormatVersion: "2010-09-09"
Transform: "AWS::Serverless-2016-10-31"
Description: "Digital Identity Fraud Credential Issuer API"

Parameters:
  CodeSigningConfigArn:
    Type: String
    Default: "none"
    Description: >
      The ARN of the Code Signing Config to use, provided by the deployment pipeline
  VpcSubnetId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Subnet::Id>
    Default: /dev/credentialIssuers/vpcConfig/subnetId
  VpcSgId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::SecurityGroup::Id>
    Default: /dev/credentialIssuers/vpcConfig/securityGroupId
  ContraIndicationTableName:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /dev/credentialIssuers/fraud/contraindicationMappingTableName
  Environment:
    Description: "The environment type"
    Type: "String"
    AllowedValues:
      - "dev"
      - "build"
      - "staging"
      - "integration"
      - "production"
    ConstraintDescription: must be dev, build, staging, integration or production
  PermissionsBoundary:
    Description: "The ARN of the permissions boundary to apply when creating IAM roles"
    Type: String
    Default: "none"

Conditions:
  CreateDevResources: !Equals
    - !Ref Environment
    - dev
  UsePermissionsBoundary:
    Fn::Not:
      - Fn::Equals:
          - !Ref PermissionsBoundary
          - "none"
Globals:
  Api:
    Auth:
      DefaultAuthorizer: AWS_IAM
  Function:
    VpcConfig:
      SecurityGroupIds:
        - !Ref VpcSgId
      SubnetIds:
        - !Ref VpcSubnetId
    PermissionsBoundary: !If
      - UsePermissionsBoundary
      - !Ref PermissionsBoundary
      - !Ref AWS::NoValue
    CodeSigningConfigArn: !If
      - CreateDevResources
      - !Ref AWS::NoValue
      - !Ref CodeSigningConfigArn
    Timeout: 30 # seconds
    Runtime: java11
    AutoPublishAlias: live
    MemorySize: 512

Resources:
  AccessTokenFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../dist/accesstoken.zip
      Handler: uk.gov.di.ipv.cri.fraud.api.handler.AccessTokenHandler
      Policies:
        - DynamoDBWritePolicy:
            TableName: !Ref AccessTokenTable
        - SSMParameterReadPolicy:
            ParameterName: !Ref ParameterCSREnrolURLDev
        - SSMParameterReadPolicy:
            ParameterName: !Ref ParameterBearerAccessTokenTtl
      Events:
        ApiAccessToken:
          Type: Api
          Properties:
            Path: /token
            Method: post
            RequestParameters:
              - method.request.header.Authorization
  CredentialIssueFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../dist/credential.zip
      Handler: uk.gov.di.ipv.cri.fraud.api.handler.CredentialHandler::handleRequest
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref AccessTokenTable
        - DynamoDBWritePolicy:
            TableName: !Ref AccessTokenTable
        - DynamoDBReadPolicy:
            TableName: !Ref ContraIndicationTableName
        - SSMParameterReadPolicy:
            ParameterName: AccessTokenTableName
        - SSMParameterReadPolicy:
            ParameterName: BearerAccessTokenTtl
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - Statement:
            - Sid: ReadParameterStorePolicy
              Effect: Allow
              Action:
                - 'ssm:GetParameter*'
              Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/dev/credentialIssuers/fraud*'
        - Statement:
            - Sid: ReadSecretsPolicy
              Effect: Allow
              Action:
                - 'secretsmanager:GetSecretValue'
              Resource: !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/dev/credentialIssuers/fraud*'
      Tracing: Active
      Environment:
        Variables:
          ENVIRONMENT: !Ref Environment
      Events:
        CredentialIssue:
          Type: Api
          Properties:
            Path: /credential
            Method: post

  AccessTokenTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'AccessToken-${AWS::StackName}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: accessToken
          AttributeType: S
      KeySchema:
        - AttributeName: accessToken
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: expiryDate
        Enabled: true

  ParameterCSREnrolURLDev:
    Type: AWS::SSM::Parameter
    Properties:
      Name: AccessTokenTableName
      Value: !Sub 'AccessToken-${AWS::StackName}'
      Type: String
      Description: access token table name

  ParameterBearerAccessTokenTtl:
    Type: AWS::SSM::Parameter
    Properties:
      Name: BearerAccessTokenTtl
      Value: 3600
      Type: String
      Description: time to live for the bearer access token (seconds)
